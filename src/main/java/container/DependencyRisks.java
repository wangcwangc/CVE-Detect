package container;

import data.dao.VulnerableDao;
import data.dao.VulnerablePackageDao;
import data.po.Vulnerable;
import data.po.VulnerablePackage;
import utiil.DetectUtil;
import utiil.MybatisUtil;
import vo.DependencyJar;
import risk.DependencyRisk;
import vo.VulnerableMethod;

import java.util.*;

public class DependencyRisks {
    private static DependencyRisks instance; // 实例

    public static DependencyRisks i() {
        return instance;
    }

    public static void init(DependencyJars dependencyJars) {
        if (instance == null) {
            instance = new DependencyRisks(dependencyJars);
        }
    }

    private DependencyRisks(DependencyJars dependencyJars) {
        container = new HashSet<>();
        Set<DependencyJar> usedDependencyJarSet = dependencyJars.getUsedDependencyJars();
        Set<VulnerablePackage> vulnerablePackageSet = getAllVulnerablePackage();
        for (DependencyJar dependencyJar : usedDependencyJarSet) {
            Map<String, Set<VulnerableMethod>> vulnerableMethodMap = new HashMap<>();
            if (vulnerablePackageSet.contains(new VulnerablePackage(dependencyJar.getGroupId(), dependencyJar.getArtifactId()))) {
                List<Vulnerable> vulnerableList = getAllVulnerableByPackage(dependencyJar.getGroupId(), dependencyJar.getArtifactId());
                for (Vulnerable vulnerable : vulnerableList) {
                    if (DetectUtil.isInVersionRange(dependencyJar.getVersion(), vulnerable.getAffectedVersion())) {
                        VulnerableMethod vulnerableMethod = new VulnerableMethod(vulnerable.getMethodLongName(), vulnerable.getParams());
                        String cveId = vulnerable.getCveId();
                        Set<VulnerableMethod> vulnerableMethodSet = vulnerableMethodMap.computeIfAbsent(cveId, key -> new HashSet<>());
                        vulnerableMethodSet.add(vulnerableMethod);
                    }
                }
            }
            for (String cveId : vulnerableMethodMap.keySet()) {
                container.add(new DependencyRisk(dependencyJar, vulnerableMethodMap.get(cveId), cveId));
            }
        }
    }

    private final Set<DependencyRisk> container;

    public Set<DependencyRisk> getAllDependencyRisks() {
        return container;
    }

    private Set<VulnerablePackage> getAllVulnerablePackage() {
        VulnerablePackageDao vulnerablePackageDao = MybatisUtil.createSqlSession().getMapper(VulnerablePackageDao.class);
        return vulnerablePackageDao.selectAllDistinctVulnerablePackage();
    }

    private List<Vulnerable> getAllVulnerableByPackage(String groupId, String artifactId) {
        VulnerableDao vulnerableDao = MybatisUtil.createSqlSession().getMapper(VulnerableDao.class);
        return vulnerableDao.selectAllVulnerableByPackage(groupId, artifactId);
    }
}
