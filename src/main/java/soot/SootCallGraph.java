package soot;

import graph.IGraph;
import risk.DependencyRisk;
import soot.transformer.CallGraphTransformer;
import utiil.MavenUtil;

import java.util.Arrays;
import java.util.List;

public class SootCallGraph extends SootAna {

    private static SootCallGraph instance = new SootCallGraph();

    private SootCallGraph() {
    }

    public static SootCallGraph i() {
        return instance;
    }

    public IGraph getGraph(DependencyRisk dependencyRisk, CallGraphTransformer transformer) {
        MavenUtil.i().getLog().info("use soot to compute reach methods for " + dependencyRisk.toString());
        IGraph graph = null;
        long start = System.currentTimeMillis();
        try {

            PackManager.v().getPack("wjtp").add(new Transform("wjtp.myTrans", transformer));

            soot.Main.main(getArgs(dependencyRisk.getJarPaths().toArray(new String[0])).toArray(new String[0]));

            graph = transformer.getGraph();

        } catch (Exception e) {
            MavenUtil.i().getLog().warn("cg error: ", e);
        }
        soot.G.reset();
        long runtime = (System.currentTimeMillis() - start) / 1000;
//        GlobalVar.time2cg += runtime;
        return graph;
    }

    @Override
    protected void addCgArgs(List<String> argsList) {
        argsList.addAll(Arrays.asList(new String[]{"-p", "cg", "off",}));
    }
}
