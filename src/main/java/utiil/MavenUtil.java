package utiil;

import detect.DetectMojo;
import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.resolver.ArtifactNotFoundException;
import org.apache.maven.artifact.resolver.ArtifactResolutionException;
import org.apache.maven.artifact.versioning.InvalidVersionSpecificationException;
import org.apache.maven.artifact.versioning.VersionRange;
import org.apache.maven.plugin.logging.Log;

import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

public class MavenUtil {
    private static MavenUtil instance = new MavenUtil();

    public static MavenUtil i() {
        return instance;
    }

    private MavenUtil() {
    }

    private DetectMojo mojo;

    public void setMojo(DetectMojo mojo) {
        this.mojo = mojo;
    }

    public void resolve(Artifact artifact) throws ArtifactResolutionException, ArtifactNotFoundException {
        mojo.resolver.resolve(artifact, mojo.remoteRepositories, mojo.localRepository);
    }

    public Log getLog() {
        return mojo.getLog();
    }

    public Artifact getArtifact(String groupId, String artifactId, String versionRange, String type, String classifier,
                                String scope) {
        try {
            return mojo.factory.createDependencyArtifact(groupId, artifactId,
                    VersionRange.createFromVersionSpec(versionRange), type, classifier, scope);
        } catch (InvalidVersionSpecificationException e) {
            getLog().error("cant create MavenArtifact!", e);
            return null;
        }
    }


    public String getProjectInfo() {
        return mojo.project.getGroupId() + ":" + mojo.project.getArtifactId() + ":" + mojo.project.getVersion() + "@"
                + mojo.project.getFile().getAbsolutePath();
    }

    /**
     * @return String pom.xml的位置
     */
    public String getProjectPom() {
        return mojo.project.getFile().getAbsolutePath();
    }

    public String getProjectCor() {
        return mojo.project.getGroupId() + ":" + mojo.project.getArtifactId() + ":" + mojo.project.getVersion();
    }

    public String getProjectGroupId() {
        return mojo.project.getGroupId();
    }

    public String getProjectArtifactId() {
        return mojo.project.getArtifactId();
    }

    public String getProjectVersion() {
        return mojo.project.getVersion();
    }

    public DetectMojo getMojo() {
        return mojo;
    }

    public File getBaseDir() {
        return mojo.project.getBasedir();
    }

    public File getBuildDir() {
        return mojo.buildDir;
    }

    public List<String> getSrcPaths() {
        List<String> srcPaths = new ArrayList<>();
        if (this.mojo == null) {
            return null;
        }
        for (String srcPath : this.mojo.compileSourceRoots) {
            if (new File(srcPath).exists())
                srcPaths.add(srcPath);
        }
        return srcPaths;
    }

    public String getMvnRep() {
        return this.mojo.localRepository.getBasedir() + "\\";
    }
}
