package vo;

import graph.IGraph;
import soot.JarAna;
import utiil.SootUtil;

import java.util.Arrays;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

public class DependencyRisk {
    private final DependencyJar dependencyJar;
    private final Set<VulnerableMethod> vulnerableMethodSet;
    private Set<String> allRiskMethods;
    private final String cveId;
    private IGraph graph;

    public DependencyRisk(DependencyJar dependencyJar, Set<VulnerableMethod> vulnerableMethodSet, String cveId) {
        this.dependencyJar = dependencyJar;
        this.vulnerableMethodSet = vulnerableMethodSet;
        this.cveId = cveId;
        initAllMethodVO();
    }

    //<org.apache.logging.log4j.core.impl.DefaultLogEventFactory: org.apache.logging.log4j.core.LogEvent createEvent(java.lang.String,
    //org.apache.logging.log4j.Marker,java.lang.String,org.apache.logging.log4j.Level,org.apache.logging.log4j.message.Message,
    //java.util.List,java.lang.Throwable)>
    private void initAllMethodVO() {
        allRiskMethods = new HashSet<>();
        Map<String, ClassVO> classVOMap = dependencyJar.getAllClass();
        for (VulnerableMethod vulnerableMethod : vulnerableMethodSet) {
            String methodName = vulnerableMethod.getMethodName();
            String[] strings = methodName.split("\\.");
            String className = methodName.replace("." + strings[strings.length - 1], "");
            if (classVOMap.containsKey(className)) {
                ClassVO classVO = classVOMap.get(className);
                for (MethodVO methodVO : classVO.getMethods()) {
                    if (methodName.split("\\.")[strings.length - 1].equals(SootUtil.methodSigToName(methodVO.getMthdSig()))) {
                        String[] targetParams = vulnerableMethod.getMethodParams().toArray(new String[]{});
                        String[] sourceParams = SootUtil.methodSigToParams(methodVO.getMthdSig());
                        if (SootUtil.isSameParams(sourceParams, targetParams)) {
                            allRiskMethods.add(methodVO.getMthdSig());
                            break;
                        }
                    }
                }
            }
        }
    }

    public Set<String> getAllRiskMethods() {
        return allRiskMethods;
    }

    @Override
    public String toString() {
        return "DependencyRisk{" +
                "dependencyJar=" + dependencyJar +
                ", vulnerableMethodSet=" + vulnerableMethodSet +
                ", cveId='" + cveId + '\'' +
                ", graph=" + graph +
                '}';
    }
}
